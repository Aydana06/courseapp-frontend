<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Сургалтыг уншиж байна...</p>
</div>

<!-- Error State -->
<div *ngIf="errorMessage && !isLoading" class="error-container">
  <h2>Алдаа гарлаа</h2>
  <p>{{ errorMessage }}</p>
  <button class="btn btn-primary" (click)="goBack()">Буцах</button>
</div>

<!-- Course Content -->
<div class="course-detail-container" *ngIf="course && !isLoading">
  <div class="container">
    <!-- Course Header -->
    <div class="course-header">
      <div class="course-image">
        <img [src]="getCourseImageUrl(course.image)" [alt]="course.title" />
      </div>
      <div class="course-info">
        <h1>{{ course.title }}</h1>
        <p class="course-description">{{ course.description }}</p>

        <div class="course-meta">
          <div class="meta-item">
            <span class="meta-label">Багш:</span>
            <span class="meta-value">{{ course.instructor }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Үргэлжлэх хугацаа:</span>
            <span class="meta-value">{{ course.duration }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Түвшин:</span>
            <span class="meta-value">{{ course.details?.[0]?.level }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Сурагч:</span>
            <span
              class="meta-value"
              >{{ course.details?.[0]?.students || 0 }}</span
            >
          </div>
        </div>

        <div class="course-rating">
          <div class="stars">
            <span
              *ngFor="let star of [1, 2, 3, 4, 5]"
              class="star"
              [class.filled]="star <= (course.details?.[0]?.rating ?? 0)"
              >★</span
            >
          </div>
          <span class="rating-text"
            >{{ course.details?.[0]?.rating ?? 0}}
            ({{ course.details?.[0]?.students ?? 0 }} сурагч)</span
          >
        </div>

        <div class="course-actions">
          <div class="course-price">
            <span class="price">{{ course.price | number }}₮</span>
          </div>

          <!-- Нэвтэрсэн үед - зөвхөн student эрхтэй хэрэглэгчдэд -->
          <button
            *ngIf="authService.isLoggedIn() && !isAdminOrInstructor()"
            class="btn btn-outline"
            (click)="addToCart(course._id)"
          >
            Сагсанд нэмэх
          </button>

          <!-- Admin/Instructor үйлдлүүд -->
          <div *ngIf="isAdminOrInstructor()" class="admin-actions">
            <button
              class="btn btn-outline"
              (click)="editCourse(course._id)"
            >
              Сургалт засах
            </button>
            <button
              *ngIf="isAdmin()"
              class="btn btn-danger"
              (click)="deleteCourse(course._id)"
            >
              Сургалт устгах
            </button>
          </div>

          <!-- Нэвтрээгүй үед -->
          <div *ngIf="!authService.isLoggedIn()" class="auth-required-card">
            <h3>Нэвтрэх шаардлагатай</h3>
            <p>
              Сургалт авахын тулд та сайтад
              <a routerLink="/login">нэвтэрч</a> эсвэл
              <a routerLink="/register">бүртгүүлнэ</a> үү.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Course Content -->
    <div class="course-content">
      <div class="content-grid">
        <!-- Lessons -->
        <div class="content-section">
          <h2>Хичээлүүд</h2>
          <div class="lessons-list">
            <div
              class="lesson-item"
              *ngFor="let lesson of course.details?.[0]?.lessons; let i = index"
            >
              <div class="lesson-number">{{ i + 1 }}</div>
              <div class="lesson-info">
                <h3>{{ lesson.title }}</h3>
                <span class="lesson-duration">{{ lesson.duration }}</span>
              </div>
              <div class="lesson-type">
                <span class="type-badge">{{ lesson.type }}</span>
              </div>
              <div class="lesson-complete" *ngIf="isEnrolled">
                <button class="btn btn-primary"
                        (click)="toggleLessonComplete(i)"
                        [disabled]="completedLessonIds.has(i + 1)">
                  <span *ngIf="!completedLessonIds.has(i + 1); else doneTpl">Дууссан</span>
                </button>
                <ng-template #doneTpl>
                  ✓ Дууссан
                </ng-template>
              </div>
            </div>
          </div>

        </div>

        <!-- Requirements -->
        <div class="content-section">
          <h2>Шаардлага</h2>
          <ul class="requirements-list">
            <li *ngFor="let requirement of course.details?.[0]?.requirements">
              {{ requirement }}
            </li>
          </ul>
        </div>
        <!-- Outcomes -->
        <div class="content-section">
          <h2>Сургах зүйлс</h2>
          <ul class="outcomes-list">
            <li *ngFor="let outcome of course.details?.[0]?.outcomes">
              {{ outcome }}
            </li>
          </ul>
        </div>
      </div>
      <app-comment [courseId]="course._id"></app-comment>
    </div>
  </div>
</div>
